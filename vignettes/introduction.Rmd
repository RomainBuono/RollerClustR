---
title: "Introduction to RollerClustR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to RollerClustR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(RollerClustR)
```

## Overview

**RollerClustR** is an R package that provides advanced clustering algorithms specifically designed to group **variables** (not observations). This approach is particularly useful for:

- Reducing dimensionality by identifying groups of redundant variables
- Understanding the correlation structure of a dataset
- Creating synthetic variables representative of variable groups
- Identifying latent dimensions in the data

## Three Clustering Methods

RollerClustR provides three complementary algorithms:

### 1. VAR_CAH: Hierarchical Agglomerative Clustering

A **bottom-up** approach that progressively merges the most similar variables.

**Advantages:**
- Complete dendrogram allowing exploration of different numbers of clusters
- Based on correlation, easy to interpret
- Robust and deterministic

**When to use:**
- For initial data exploration
- When you want to visualize the hierarchy of variables
- For continuous numeric data

### 2. VARCLUS: Divisive Clustering

A **top-down** approach that recursively splits groups of variables.

**Advantages:**
- Automatically identifies hierarchical structures
- Uses PCA and Varimax rotation for better interpretability
- Stopping criterion based on eigenvalues

**When to use:**
- For complex multi-level structures
- When you want data-driven division
- To understand intrinsic dimensionality

### 3. TandemVarClust: Tandem Clustering for Mixed Data

A **Tandem** approach combining Multiple Correspondence Analysis (MCA) with Hierarchical Agglomerative Clustering (HAC) on modalities.

**Advantages:**
- Specialized for mixed data (quantitative and categorical)
- Clustering at the modality level (finer than variable level)
- Automatic discretization of continuous variables
- Assignment of observations to clusters via Dice index

**When to use:**
- For categorical or mixed data
- When you need to analyze illustrative variables
- For surveys or qualitative data
- When you want to capture fine structures at the modality level

## Basic Usage

### Simple Method: Wrapper Function

The easiest way to use RollerClustR is via the `roller_clust()` function:

```{r basic_usage}
# Load iris data
data(iris)

# Clustering with VAR_CAH
result <- roller_clust(
  X = iris[, 1:4],
  method = "var_cah",
  K = 2,
  scale = TRUE
)

# Display summary
result$summary()

# Access groups
print(result$Groupes)
```

### Advanced Method: R6 Classes

For more control, use R6 classes directly:

```{r r6_usage}
# Create a VAR_CAH object
model <- VAR_CAH$new(K = 2, scale = TRUE)

# Fit on data
model$fit(iris[, 1:4])

# Display summary
model$summary()

# Modify number of clusters
model$K <- 3
```

## Complete Example: Iris Dataset Analysis

### Step 1: Initial Exploration

```{r iris_exploration}
# View data structure
str(iris[, 1:4])

# Correlation matrix
cor(iris[, 1:4])
```

### Step 2: Clustering with Different Methods

```{r iris_clustering}
# Method 1: VAR_CAH
model_cah <- roller_clust(iris[, 1:4], method = "var_cah", K = 2)
cat("\n=== VAR_CAH ===\n")
print(model_cah$Groupes)

# Method 2: VARCLUS
model_vc <- roller_clust(iris[, 1:4], method = "varclus", K = 2)
cat("\n=== VARCLUS ===\n")
print(model_vc$Groupes)
```

### Step 3: Results Comparison

```{r iris_comparison}
# Compare assignments
comparison <- data.frame(
  Variable = names(iris[, 1:4]),
  VAR_CAH = model_cah$Groupes,
  VARCLUS = model_vc$Groupes
)
print(comparison)
```

## Example with Mixed Data: Iris with Categorical Variables

```{r iris_mixed_example}
# Create mixed data from iris
iris_mixed <- iris
iris_mixed$Size <- cut(iris$Sepal.Length, 
                       breaks = 3, 
                       labels = c("Small", "Medium", "Large"))
iris_mixed$PetalSize <- cut(iris$Petal.Length,
                             breaks = 3,
                             labels = c("Short", "Medium", "Long"))

# Select numeric and categorical variables
data_mixed <- iris_mixed[, c("Sepal.Width", "Petal.Width", "Size", "PetalSize")]

# Use TandemVarClust for mixed data
model_tandem <- roller_clust(
  X = data_mixed,
  method = "tandem",
  K = 2,
  n_bins = 3
)

cat("\n=== TandemVarClust - Modality Clustering ===\n")
print(model_tandem$Groupes)

cat("\n=== Summary by Original Variable ===\n")
print(model_tandem$get_variable_summary())
```

## Illustrative Variable Analysis with TandemVarClust

TandemVarClust allows analyzing illustrative variables to understand their association with clusters:

```{r tandem_predict}
# After fitting the model, analyze Species as an illustrative variable
model_tandem <- TandemVarClust$new(K = 2, n_bins = 3)
model_tandem$fit(data_mixed)

# Analyze Species association with clusters
results <- model_tandem$predict(newdata = data.frame(Species = iris$Species))

cat("\n=== Species Association with Clusters ===\n")
cat("Cramer's V:", results$Species$cramers_v, "\n")
cat("p-value (Chi²):", results$Species$chi2_test$p.value, "\n")
cat("Significant association:", results$Species$significant, "\n")

# Contingency table
cat("\nContingency table:\n")
print(results$Species$contingency)
```

## Advanced Features

### Dynamic K Modification

```{r dynamic_k}
# Create a model with K=2
model <- VAR_CAH$new(K = 2)
model$fit(iris[, 1:4])

cat("With K=2:\n")
print(model$Groupes)

# Change K (automatically refits)
model$K <- 3

cat("\nAfter modification to K=3:\n")
print(model$Groupes)
```

### K Modification for TandemVarClust

```{r dynamic_k_tandem}
# TandemVarClust uses refit_with_k() to change K
model_tandem <- TandemVarClust$new(K = 2, n_bins = 3)
model_tandem$fit(data_mixed)

cat("With K=2:\n")
cat("Number of clusters:", model_tandem$K, "\n")

# Change K
model_tandem$refit_with_k(3)

cat("\nAfter refit_with_k(3):\n")
cat("Number of clusters:", model_tandem$K, "\n")
```

### Missing Value Handling

```{r na_handling}
# Create data with NA
iris_na <- iris[, 1:4]
iris_na[1:5, 1] <- NA

# Option 1: Warning (default)
model_warn <- roller_clust(iris_na, na.action = "warn")

# Option 2: Remove observations with NA
model_omit <- roller_clust(iris_na, na.action = "omit")

# Option 3: Stop if NA
# model_fail <- roller_clust(iris_na, na.action = "fail")  # Generates error
```

## Interpreting Results

### For VAR_CAH and VARCLUS

Variables in the same cluster are highly correlated with each other. Each cluster can be represented by a **synthetic variable** calculated as the first principal component of the cluster.

**Interpretation Example:**
```{r interpretation}
model <- VAR_CAH$new(K = 2)
model$fit(iris[, 1:4])

# If we get:
# Cluster 1: Sepal.Length, Sepal.Width
# Cluster 2: Petal.Length, Petal.Width

# Interpretation: 
# - Cluster 1 represents the "Sepal" dimension
# - Cluster 2 represents the "Petal" dimension
```

### For TandemVarClust

TandemVarClust works at the **modality level** (categories of categorical variables and discretized intervals of continuous variables). Modalities in the same cluster have similar profiles in the factorial space derived from MCA.

**Interpretation:**

1. **Modality Clusters**: Each cluster groups modalities (e.g., "Size.Small", "PetalSize.Short", "Sepal.Width.bin1")

2. **Variable Summary**: The `get_variable_summary()` method aggregates results at the original variable level:
   - **cluster_principal**: Cluster containing the majority of the variable's modalities
   - **purity**: Proportion of modalities in the principal cluster (1.0 = all modalities in the same cluster)

3. **Illustrative Variables**: The `predict()` method analyzes the association between a categorical variable and clusters via:
   - **Cramer's V**: Measures association intensity (0 to 1)
   - **Chi-square test**: Tests association significance
   - **Contingency tables**: Distribution of modalities across clusters

**Interpretation Example:**
```{r tandem_interpretation}
model_tandem <- TandemVarClust$new(K = 2, n_bins = 3)
model_tandem$fit(data_mixed)

# Variable summary
summary <- model_tandem$get_variable_summary()
print(summary)

# Interpretation:
# - If "Size" has purity = 1.0 and cluster_principal = 1
#   → All Size modalities (Small, Medium, Large) are in cluster 1
#   → Homogeneous variable
# 
# - If "Sepal.Width" has purity = 0.67 and cluster_principal = 2
#   → 67% of Sepal.Width bins are in cluster 2
#   → More dispersed variable across clusters
```

## Practical Tips

1. **Start with VAR_CAH** for initial exploration of numeric data
2. **Compare with VARCLUS** to validate structure
3. **Use TandemVarClust** for mixed data (quantitative + categorical)
4. **Standardize** (`scale = TRUE`) if variables have different scales
5. **Try multiple K values** to identify optimal number of clusters
6. **Always examine** the correlation matrix first (for VAR_CAH/VARCLUS)
7. **For TandemVarClust**:
   - Adjust `n_bins` according to desired granularity for continuous variables
   - Use `n_factors` to control the number of retained factorial axes
   - Analyze variance explained by axes: `model$VarianceExplained`

## Comparison of Three Methods

| Criterion | VAR_CAH | VARCLUS | TandemVarClust |
|-----------|---------|---------|----------------|
| **Data Type** | Numeric | Numeric | Mixed (numeric + categorical) |
| **Approach** | Agglomerative (bottom-up) | Divisive (top-down) | Tandem (MCA + HAC) |
| **Clustering Unit** | Variables | Variables | Modalities |
| **Number of Clusters** | Fixed in advance (K) | Automatic or fixed | Fixed in advance (K) |
| **Visualization** | Dendrogram | Division tree | Modality dendrogram |
| **Illustrative Variables** | Via predict() | Via predict() | Via predict() with statistical tests |
| **Complexity** | Simple | Medium | High |

## Going Further

- Consult class documentation: `?VAR_CAH`, `?VARCLUS`, `?TandemVarClust`
- Explore additional arguments: `?roller_clust`
- Report bugs on GitHub: https://github.com/yourusername/RollerClustR/issues

## References

- Hastie, T., Tibshirani, R., & Friedman, J. (2009). *The Elements of Statistical Learning*
- SAS Institute Inc. (2021). *SAS/STAT User's Guide: The VARCLUS Procedure*
- Escofier, B. (1979). Traitement simultané de variables quantitatives et qualitatives. *Les Cahiers de l'Analyse des Données*, IV(2), 137-146.
- Pagès, J. (2004). Analyse factorielle de données mixtes. *Revue de Statistique Appliquée*, 52(4), 93-111.
- Dice, L. R. (1945). Measures of the amount of ecologic association between species. *Ecology*, 26(3), 297-302.
